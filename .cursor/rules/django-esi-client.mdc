---
description: django-esi client — result() vs results() and pagination
globs: backend/**/*.py
alwaysApply: false
---

# django-esi Client: result() vs results()

We use **django-esi** (ESI client built on bravado). Its `CachingHttpFuture` has two methods that are easy to confuse:

| Method | Behavior |
|--------|----------|
| **`result()`** | One request, one page. Returns the single page of data (and optionally response headers). |
| **`results()`** | **All pages.** If the operation has a `page` param, it loops internally (page 1, 2, … X-Pages), concatenates every page, and returns the full list. |

So for any paginated ESI operation, **`operation.results()` always returns the complete dataset**. Do **not** pass `page` when using `results()` — the method loops internally (1, 2, … X-Pages) and overwrites the page param itself.

## When to use which

- **Need all pages (e.g. aggregate into prices, export, small/medium lists):**  
  Call **`results()` once**. Do not pass `page`; do not loop and call `results()` per page (that would request the full set every time and can cause infinite loops).

  ```python
  # ✅ GOOD — one call, get everything; no page param
  operation = esi_provider.client.Market.get_markets_structures_structure_id(
      structure_id=structure_id,
      token=token,
  )
  all_orders = operation.results()
  # process all_orders
  ```

- **Need one page only (e.g. Celery task per page, streaming, memory-bound):**  
  Do **not** use `results()`. Use raw `requests.get` with the desired `page` and read `X-Pages` from headers, so you control pagination yourself. The client does not expose a “single-page” call that respects `page` without fetching the rest.

  ```python
  # ✅ GOOD — single page via raw request
  resp = requests.get(
      f"{ESI_BASE_URL}/markets/structures/{structure_id}/",
      params={"page": page},
      headers={"Authorization": f"Bearer {token}"},
      timeout=30,
  )
  total_pages = int(resp.headers.get("X-Pages", 1))
  page_data = resp.json() if resp.content else []
  ```

## Summary

- **`results()`** = “give me everything” (all pages). Use when you need the full list.
- **`result()`** = one page, but django-esi’s `results()` implementation still loops when `page` is in the operation — so for paginated endpoints, “one page” is best done with a direct HTTP request and `X-Pages`, not the client’s `result()`.

Reference: `esi/clients.py` → `CachingHttpFuture.results()` (lines 75–115) loops over pages when `"page" in self.operation.params`.
