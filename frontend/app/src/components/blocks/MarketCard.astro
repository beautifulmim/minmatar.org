---
import { i18n } from '@helpers/i18n'
const { t } = i18n(Astro.url)

import type { SellOrderItem } from '@dtypes/api.minmatar.org'

interface Props {
    item:                       SellOrderItem;
    init_tooltips:              boolean;
    no_expectation_progress?:   boolean;
    is_baseline:                boolean;
}

const {
    item,
    init_tooltips = false,
    no_expectation_progress = true,
    is_baseline,
} = Astro.props

const expected_quantity = item.expected_quantity ?? 0
const current_quantity = item.current_quantity ?? 0
const low_amount = expected_quantity > 0 && (current_quantity <= (20 * expected_quantity) / 100)
const completion = current_quantity > expected_quantity ? 100 : expected_quantity > 0 ? (current_quantity / expected_quantity * 100) : 100

const markup_pct = (item.lowest_price != null && item.baseline_price != null && item.baseline_price > 0)
        ? ((item.lowest_price - item.baseline_price) / item.baseline_price) * 100
        : null

import { get_item_icon, get_bpc_icon } from '@helpers/eve_image_server'
import { number_thousand_separator } from '@helpers/numbers'

const markup_tooltip = t('markup_tooltip').replace('{lowest}', number_thousand_separator(item?.lowest_price ?? 0)).replace('{baseline}', number_thousand_separator(item?.baseline_price ?? 0))

import Flexblock from '@components/compositions/Flexblock.astro';
import FlexInline from '@components/compositions/FlexInline.astro';
import FlexInlineSiblings from '@components/compositions/FlexInlineSiblings.astro';
import FixedFluid from '@components/compositions/FixedFluid.astro';

import Progress from '@components/blocks/Progress.astro';
import Picture from '@components/blocks/Picture.astro';
import CharacterPicture from '@components/blocks/CharacterPicture.astro';
import Tag from '@components/blocks/Tag.astro';
---

<FlexInline class="[ market-card ]">
    <FixedFluid class="[ items-center! basis-[550px] ]" width='64px'>
        {item.category_name !== 'SKINs' ?
            <Picture
                src={item.category_name === 'Blueprint' ?
                    get_bpc_icon(item.type_id ?? 0, false, 64) :
                    get_item_icon(item.type_id ?? 0, 64)
                }
                placeholder={item.category_name === 'Blueprint' ? get_bpc_icon(item.type_id ?? 0, true, 64) : undefined}
                size={64}
            /> :
            <div></div>
        }
        <Flexblock gap='var(--space-3xs)'>
            <FlexInlineSiblings shrinkable-sibbling='first' min-shink-width='250px'>
                <Flexblock gap='var(--space-3xs)'>
                    <h3 class="[ title ]">{item.item_name}</h3>
                    <small class="[ subtitle ]">{item.category_name} / {item.group_name}</small>
                </Flexblock>
                <Flexblock>
                    <span class="[ quantity ]">{number_thousand_separator(current_quantity)}{expected_quantity > 0 && `/${number_thousand_separator(expected_quantity)}`}</span>
                </Flexblock>
            </FlexInlineSiblings>
            {(no_expectation_progress || expected_quantity > 0) &&
                <Progress
                    class:list={[ 'w-full', { danger: low_amount }, { disabled: expected_quantity === 0 } ]}
                    max="100"
                    value={completion > 0 ? completion : 0.1}
                    data-tippy-content={expected_quantity > 0 ? `${completion.toFixed(0)}%` : t('no_expectation')}
                    x-init={init_tooltips ? 'tippy($el, tippy_options)' : undefined}
                >
                    {completion.toFixed(2)}%
                </Progress>
            }
        </Flexblock>
    </FixedFluid>

    {!is_baseline && markup_pct != null && 
        <Tag
            text={`${markup_pct > 0 ? '+' : ''}${number_thousand_separator(markup_pct)}%`}
            color={markup_pct > 0 ? 'fleet-red' : markup_pct < 0 ? 'green' : 'alliance-blue'}
            data-tippy-content={markup_tooltip}
            x-init={init_tooltips ? 'tippy($el, tippy_options)' : undefined}
        />
    }

    {item.issuer_ids.length > 0 &&
        <FlexInline gap='var(--space-3xs)' class="[ sell-order-issuers ]">
            {item.issuer_ids.map((issuer_id) => (
                <CharacterPicture
                    character_id={issuer_id}
                    size={24}
                    icon_quality={32}
                />
            ))}
        </FlexInline>
    }
</FlexInline>

<style lang="scss">
    .market-card {
        > div {
            padding-right: var(--space-3xs);
        }

        @media (hover: hover) {
            .action-button {
                transition: var(--fast-transition);
                opacity: 0;
            }

            &:hover,
            &:focus-within {
                .action-button {
                    opacity: 1;
                }
            }
        }
    }

    .quantity {
        font-family: var(--heading-font);
        text-transform: uppercase;
        font-size: var(--step-0);
        font-weight: 400;
        color: var(--highlight);
        line-height: 1.2;
    }

    .title {
        min-width: 0;
        flex: 1;
        font-size: var(--step-0);
        line-height: 1.2;
    }
</style>
