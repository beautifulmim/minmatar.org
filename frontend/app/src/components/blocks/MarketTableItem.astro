---
import { i18n } from '@helpers/i18n'
const { t } = i18n(Astro.url)

import type { SellOrderItem } from '@dtypes/api.minmatar.org'

interface Props {
    item:                       SellOrderItem;
    init_tooltips:              boolean;
    no_expectation_progress?:   boolean;
    is_baseline:                boolean;
}

const {
    item,
    init_tooltips = false,
    no_expectation_progress = true,
    is_baseline,
} = Astro.props

const expected_quantity = item.expected_quantity ?? 0
const current_quantity = item.current_quantity ?? 0
const low_amount = expected_quantity > 0 && (current_quantity <= (20 * expected_quantity) / 100)
const completion = current_quantity > expected_quantity ? 100 : expected_quantity > 0 ? (current_quantity / expected_quantity * 100) : 100

const effective_baseline = (item.baseline_sell_price != null && item.baseline_sell_price > 0)
                            ? item.baseline_sell_price
                            : item.baseline_price
const markup_pct = (item.current_lowest_price != null && effective_baseline != null && effective_baseline > 0)
                    ? ((item.current_lowest_price - effective_baseline) / effective_baseline) * 100
                    : null

const baseline_label = (item.baseline_sell_price != null && item.baseline_sell_price > 0)
                        ? t('sell_orders.baseline_sell')
                        : t('sell_orders.market_avg')

import { get_item_icon, get_bpc_icon } from '@helpers/eve_image_server'
import { number_thousand_separator } from '@helpers/numbers'

const markup_tooltip = t('markup_tooltip')
                            .replace('{lowest}', number_thousand_separator(item?.current_lowest_price ?? 0))
                            .replace('{baseline}', number_thousand_separator(effective_baseline ?? 0))
                            .replace('{baseline_label}', baseline_label)

const progress_color = completion >= 50 ? '--security-status-point-6' :
                       completion >= 10 && completion < 50 ? '--security-status-point-4':
                       '--fleet-red'

import Flexblock from '@components/compositions/Flexblock.astro';
import FlexInline from '@components/compositions/FlexInline.astro';
import FixedFluid from '@components/compositions/FixedFluid.astro';

import Progress from '@components/blocks/Progress.astro';
import Picture from '@components/blocks/Picture.astro';
import CharacterPicture from '@components/blocks/CharacterPicture.astro';
import Tag from '@components/blocks/Tag.astro';
---

<FlexInline class="[ market-table-item ]">
    <FixedFluid class="[ items-center! basis-[550px] ]" width='32px'>
        {item.category_name !== 'SKINs' ?
            <Picture
                src={item.category_name === 'Blueprint' ?
                    get_bpc_icon(item.type_id ?? 0, false, 32) :
                    get_item_icon(item.type_id ?? 0, 32)
                }
                placeholder={item.category_name === 'Blueprint' ? get_bpc_icon(item.type_id ?? 0, true, 32) : undefined}
                size={32}
            /> :
            <div></div>
        }
        <Flexblock gap='var(--space-3xs)'>
            <FlexInline class="[ min-w-0 ]">
                <Flexblock gap='var(--space-3xs)' class="[ min-w-[250px] flex-1 ]">
                    <span class="[ title ]">{item.item_name}</span>
                    <small class="[ category ][ sr-only ]">{item.category_name}</small>
                    <small class="[ group ][ sr-only ]">{item.group_name}</small>
                </Flexblock>
            </FlexInline>
            {/*(no_expectation_progress || expected_quantity > 0) &&
                <Progress
                    class:list={[ 'w-full', { danger: low_amount }, { disabled: expected_quantity === 0 } ]}
                    max="100"
                    value={completion > 0 ? completion : 0.1}
                    data-tippy-content={expected_quantity > 0 ? `${completion.toFixed(0)}%` : t('no_expectation')}
                    x-init={init_tooltips ? 'tippy($el, tippy_options)' : undefined}
                >
                    {completion.toFixed(2)}%
                </Progress>
            */}
        </Flexblock>
    </FixedFluid>

    <FlexInline class="[ basis-[180px] ]" gap="var(--space-3xs)">
        <span>{number_thousand_separator(current_quantity)}</span>
        {expected_quantity > 0 &&
            <span>/</span>
            <span class="[ text-highlight ]">{number_thousand_separator(expected_quantity)}</span>
        }
    </FlexInline>

    <Flexblock class="[ basis-[80px] ]">
        {(no_expectation_progress || expected_quantity > 0) &&
            <Progress
                class:list={[ 'w-full', { danger: low_amount }, { disabled: expected_quantity === 0 } ]}
                max="100"
                value={completion > 0 ? completion : 0.1}
                data-tippy-content={expected_quantity > 0 ? `${completion.toFixed(0)}%` : t('no_expectation')}
                x-init={init_tooltips ? 'tippy($el, tippy_options)' : undefined}
                style={`--progress-color: var(${progress_color}); --progress-glow-color: var(${progress_color});`}
            >
                {completion.toFixed(2)}%
            </Progress>
        }
    </Flexblock>

    <Flexblock class="[ basis-[120px] ]">
        {expected_quantity > 0 &&
            <span class:list={[
                    { 'text-status-point-6': completion >= 50 },
                    { 'text-status-point-4': completion >= 10 && completion < 50 },
                    { 'text-red': completion >= 0 && completion < 10 },
                ]}
            >
                {completion.toFixed(0)}%
            </span>
        }
    </Flexblock>

    {!is_baseline && markup_pct != null && 
        <Tag
            text={`${markup_pct > 0 ? '+' : ''}${number_thousand_separator(markup_pct)}%`}
            color={markup_pct > 0 ? 'fleet-red' : markup_pct < 0 ? 'green' : 'alliance-blue'}
            data-tippy-content={markup_tooltip}
            x-init={init_tooltips ? 'tippy($el, tippy_options)' : undefined}
        />
    }

    {item.issuer_ids.length > 0 &&
        <FlexInline gap='var(--space-3xs)' class="[ sell-order-issuers ]">
            {item.issuer_ids.map((issuer_id) => (
                <CharacterPicture
                    character_id={issuer_id}
                    size={24}
                    icon_quality={32}
                />
            ))}
        </FlexInline>
    }
</FlexInline>

<style lang="scss">
    .market-table-item {
        > div {
            padding-right: var(--space-3xs);
        }

        @media (hover: hover) {
            .action-button {
                transition: var(--fast-transition);
                opacity: 0;
            }

            &:hover,
            &:focus-within {
                .action-button {
                    opacity: 1;
                }
            }
        }
    }

    .quantity {
        font-family: var(--heading-font);
        text-transform: uppercase;
        font-size: var(--step-0);
        font-weight: 400;
        color: var(--highlight);
        line-height: 1.2;
    }
</style>
