---
import { i18n } from '@helpers/i18n'
const { t, translatePath } = i18n(Astro.url)

import type { SellOrderLocation } from '@helpers/api.minmatar.org/market'
import { get_sell_orders } from '@helpers/api.minmatar.org/market'
import { prod_error_messages } from '@helpers/env'

let sell_order_locations: SellOrderLocation[] = []
let data_fetching_error = ''

try {
    sell_order_locations = await get_sell_orders()
} catch (error) {
    data_fetching_error = prod_error_messages() ? t('sell_orders.page_title') : error.message
}

let active_location_name = Astro.url.searchParams.get('location_name') ?? (sell_order_locations[0]?.location_name ?? '')

if (sell_order_locations.length > 0) {
    if (active_location_name === '' || !sell_order_locations.find(loc => loc.location_name === active_location_name))
        active_location_name = sell_order_locations[0].location_name
}

const active_location = sell_order_locations.find(loc => loc.location_name === active_location_name)
const non_active_locations = sell_order_locations.filter(loc => loc.location_name !== active_location_name)

const is_baseline = active_location?.is_price_baseline ?? false

interface ItemDisplay {
    item_name: string
    type_id: number | null
    category_id: number | null
    category_name: string
    group_id: number | null
    group_name: string
    expected_quantity: number
    current_quantity: number
    fulfilled: boolean
    issuer_ids: number[]
    completion: number
    low_amount: boolean
    lowest_price: number | null
    baseline_price: number | null
    markup_pct: number | null
}

function to_display(item: { item_name: string, type_id: number | null, category_id: number | null, category_name: string, group_id: number | null, group_name: string, expected_quantity: number, current_quantity: number, fulfilled: boolean, issuer_ids: number[], lowest_price: number | null, baseline_price: number | null }): ItemDisplay {
    const completion = item.expected_quantity > 0
        ? Math.min(100, (item.current_quantity / item.expected_quantity) * 100)
        : 100
    const threshold = (20 * item.expected_quantity) / 100
    const low_amount = item.expected_quantity > 0 && item.current_quantity <= threshold
    const markup_pct = (item.lowest_price != null && item.baseline_price != null && item.baseline_price > 0)
        ? ((item.lowest_price - item.baseline_price) / item.baseline_price) * 100
        : null
    return { ...item, completion, low_amount, markup_pct }
}

const items_with_expectations: ItemDisplay[] = (active_location?.items.filter(i => i.expected_quantity > 0) ?? []).map(to_display)
const items_without_expectations: ItemDisplay[] = (active_location?.items.filter(i => i.expected_quantity === 0) ?? []).map(to_display)

function groupByCategory(items: ItemDisplay[]): [string, ItemDisplay[]][] {
    const map = new Map<string, ItemDisplay[]>()
    for (const item of items) {
        const key = item.category_name?.trim() || t('sell_orders.group_other')
        if (!map.has(key)) map.set(key, [])
        map.get(key)!.push(item)
    }
    for (const arr of map.values()) arr.sort((a, b) => a.item_name.localeCompare(b.item_name))
    const otherLabel = t('sell_orders.group_other')
    const sorted = [...map.entries()].sort(([a], [b]) => {
        if (a === otherLabel) return 1
        if (b === otherLabel) return -1
        return a.localeCompare(b)
    })
    return sorted
}

const expected_by_group = groupByCategory(items_with_expectations)
const other_by_group = groupByCategory(items_without_expectations)

const total_items = (active_location?.items.length ?? 0)

function get_completion(items: ItemDisplay[]) {
    if (items.length === 0) return 100
    let completion = 0
    items.forEach(item => {
        if (item.expected_quantity > 0 && item.current_quantity >= item.expected_quantity)
            completion += 100
        else if (item.expected_quantity > 0)
            completion += (item.current_quantity / item.expected_quantity) * 100
    })
    return completion / items.length
}

const active_completion = get_completion(items_with_expectations)

const shortfall_items = items_with_expectations
    .filter(item => item.current_quantity < item.expected_quantity)
    .map(item => ({
        item_name: item.item_name,
        category_name: item.category_name?.trim() || t('sell_orders.group_other'),
        needed: item.expected_quantity - item.current_quantity,
    }))
const shortfall_categories = [...new Set(shortfall_items.map(i => i.category_name))].sort((a, b) => {
    const other = t('sell_orders.group_other')
    if (a === other) return 1
    if (b === other) return -1
    return a.localeCompare(b)
})
const shopping_list_text = shortfall_items
    .map(item => `${item.item_name} x${item.needed}`)
    .join('\n')

const non_active_completions = non_active_locations.map(loc => {
    const expected_items = loc.items.filter(i => i.expected_quantity > 0)
    return {
        ...loc,
        completion: get_completion(expected_items),
        item_count: loc.items.length,
    }
})

import { query_string } from '@helpers/string'

import Viewport from '@layouts/Viewport.astro';

import PageDefault from '@components/page/PageDefault.astro';
import PageTitle from '@components/page/PageTitle.astro';

import Flexblock from '@components/compositions/Flexblock.astro';
import FlexInline from '@components/compositions/FlexInline.astro';
import Wrapper from '@components/compositions/Wrapper.astro';
import BlockList from '@components/compositions/BlockList.astro';

import Button from '@components/blocks/Button.astro';
import CharacterPicture from '@components/blocks/CharacterPicture.astro';
import ErrorRefetch from '@components/blocks/ErrorRefetch.astro';
import Input from '@components/blocks/Input.astro';
import ItemPicture from '@components/blocks/ItemPicture.astro';
import Progress from '@components/blocks/Progress.astro';
import LocationsReel from '@components/blocks/LocationsReel.astro';
import LocationsReelSlide from '@components/blocks/LocationsReelSlide.astro';

import MagnifierIcon from '@components/icons/buttons/MagnifierIcon.astro';

const page_title = t('sell_orders.page_title')
const page_description = t('sell_orders.leading_text')

const REEL_GAP = 80
---

<Viewport
    title={page_title}
    meta_description={t('sell_orders.meta_description')}
>
    <PageDefault
        cover={{
            image: "/images/market-cover.jpg",
            image_990: "/images/market-cover.jpg",
            animated: false,
            scrollable: true,
            overlay: true,
        }}
        x-data={`{
            items_count: ${total_items},
            item_name_filter: '',
            show_filter: 'all',
            countVisibleElements(selector, parent = document) {
                const elements = parent.querySelectorAll(selector)
                let visible_count = 0
                elements.forEach(element => {
                    const is_visible = element.offsetParent !== null
                    if (is_visible) visible_count++
                })
                return visible_count
            },
            show_item(el) {
                const name_el = el.querySelector('.item-name')
                if (!name_el) return true
                const name_match = this.item_name_filter === '' || name_el.textContent.toLowerCase().includes(this.item_name_filter.toLowerCase())
                return name_match
            },
        }`}
    >
        <FlexInline slot="header" justification='space-between' class="[ w-full ]">
            <Flexblock gap="var(--space-3xs)">
                <PageTitle>
                    {page_title}
                </PageTitle>
                <small x-text={`\`${t('showing')} \${items_count} \${items_count !== 1 ? '${t('item')}s' : '${t('item')}'}\``}>
                    {t('showing')} {total_items} {total_items !== 1 ? `${t('item')}s` : t('item')}
                </small>
            </Flexblock>
            <FlexInline gap='var(--space-s)' class="[ flex-wrap items-center ]">
                {active_location && shortfall_items.length > 0 &&
                    <div
                        class="[ sell-orders-copy-wrapper ]"
                        id="sell-orders-shortfall-data"
                        data-items={JSON.stringify(shortfall_items)}
                        data-categories={JSON.stringify(shortfall_categories)}
                        x-data={`{
                            shortfallItems: [],
                            shortfallCategories: [],
                            selectedCategoryNames: [],
                            copied: false,
                            copiedLabel: '',
                            open: false,
                            init() {
                                const el = document.getElementById('sell-orders-shortfall-data')
                                if (el?.dataset?.items) {
                                    this.shortfallItems = JSON.parse(el.dataset.items)
                                    this.shortfallCategories = JSON.parse(el.dataset.categories)
                                }
                            },
                            toggleCategory(name) {
                                const i = this.selectedCategoryNames.indexOf(name)
                                if (i >= 0) this.selectedCategoryNames.splice(i, 1)
                                else this.selectedCategoryNames.push(name)
                                this.selectedCategoryNames = [...this.selectedCategoryNames]
                            },
                            selectAllCategories() { this.selectedCategoryNames = [...this.shortfallCategories] },
                            deselectAllCategories() { this.selectedCategoryNames = [] },
                            copyToClipboard(text, label) {
                                const self = this
                                function onSuccess() {
                                    self.copied = true
                                    self.copiedLabel = label || ''
                                    setTimeout(() => { self.copied = false; self.copiedLabel = '' }, 2000)
                                }
                                if (navigator.clipboard && navigator.clipboard.writeText) {
                                    navigator.clipboard.writeText(text).then(onSuccess).catch(() => {
                                        const ta = document.createElement('textarea')
                                        ta.value = text
                                        ta.style.position = 'fixed'
                                        ta.style.opacity = '0'
                                        document.body.appendChild(ta)
                                        ta.select()
                                        document.execCommand('copy')
                                        document.body.removeChild(ta)
                                        onSuccess()
                                    })
                                } else {
                                    const ta = document.createElement('textarea')
                                    ta.value = text
                                    ta.style.position = 'fixed'
                                    ta.style.opacity = '0'
                                    document.body.appendChild(ta)
                                    ta.select()
                                    document.execCommand('copy')
                                    document.body.removeChild(ta)
                                    onSuccess()
                                }
                            },
                            copyFullList() {
                                const text = this.shortfallItems.map(item => item.item_name + ' x' + item.needed).join(String.fromCharCode(10))
                                this.copyToClipboard(text, 'full')
                            },
                            copySelected() {
                                const filtered = this.shortfallItems.filter(item => this.selectedCategoryNames.includes(item.category_name))
                                const text = filtered.map(item => item.item_name + ' x' + item.needed).join(String.fromCharCode(10))
                                this.copyToClipboard(text, 'selected')
                                this.open = false
                            }
                        }`}
                    >
                        <FlexInline gap='var(--space-2xs)' class="[ items-center ]">
                            <button
                                type="button"
                                class="[ button copy-btn ]"
                                data-size="sm"
                                x-on:click="copyFullList()"
                                x-text={`copied && copiedLabel === 'full' ? '${t('copied')}' : '${t('copy_full_list')}'`}
                            >
                                {t('copy_full_list')}
                            </button>
                            <button
                                type="button"
                                class="[ copy-options-toggle ]"
                                aria-haspopup="true"
                                x-bind:aria-expanded="open"
                                x-on:click="open = !open"
                                x-text={`'${t('sell_orders.copy_options')}' + (open ? ' ▲' : ' ▼')`}
                            />
                        </FlexInline>
                        <div class="[ copy-options-panel ]" x-show="open" x-cloak x-transition>
                            <p class="[ copy-options-title ]">{t('sell_orders.select_categories')}</p>
                            <FlexInline gap='var(--space-2xs)' class="[ copy-options-actions ]">
                                <button type="button" x-on:click="selectAllCategories()">{t('sell_orders.select_all_categories')}</button>
                                <button type="button" x-on:click="deselectAllCategories()">{t('sell_orders.deselect_all_categories')}</button>
                            </FlexInline>
                            <Flexblock gap='var(--space-2xs)' class="[ copy-options-checkboxes ]">
                                <template x-for="cat in shortfallCategories" :key="cat">
                                    <label class="[ copy-options-label ]">
                                        <input type="checkbox" x-bind:value="cat" x-model="selectedCategoryNames" />
                                        <span x-text="cat"></span>
                                    </label>
                                </template>
                            </Flexblock>
                            <button
                                type="button"
                                class="[ button copy-btn copy-selected-btn ]"
                                data-size="sm"
                                x-on:click="copySelected()"
                                x-bind:disabled="selectedCategoryNames.length === 0"
                                x-text={`copied && copiedLabel === 'selected' ? '${t('copied')}' : '${t('sell_orders.copy_selected')}'`}
                            >
                                {t('sell_orders.copy_selected')}
                            </button>
                        </div>
                    </div>
                }
                <Input type="text"
                    placeholder={t('filter')}
                    x-model="item_name_filter"
                    x-on:keyup="setTimeout(function () { items_count = countVisibleElements('.sell-order-row') })"
                    x-init="$el.focus()"
                >
                    <MagnifierIcon slot="icon" />
                </Input>
            </FlexInline>
        </FlexInline>

        {data_fetching_error ?
            <ErrorRefetch
                args={{
                    partial: translatePath('/market/sell-orders/'),
                    message: data_fetching_error,
                    delay: 0,
                }}
            />
        :
        active_location ?
            <Flexblock gap='var(--space-xl)'>
                <LocationsReel gap={REEL_GAP}>
                    <LocationsReelSlide gap={REEL_GAP}>
                        <Flexblock gap='var(--space-2xs)'>
                            <h2>
                                <a href={translatePath(`/market/sell-orders?${query_string({
                                        location_name: active_location.location_name
                                    })}`)}>
                                    {active_location.location_name}
                                </a>
                            </h2>
                            <Progress
                                class:list={[ 'w-full', { danger: active_completion < 30 } ]}
                                max="100"
                                value={active_completion > 0 ? active_completion : 0.1}
                                data-tippy-content={`${active_completion.toFixed(0)}%`}
                            >
                                {active_completion.toFixed(2)}%
                            </Progress>
                            <small>{`${total_items} ${total_items != 1 ? `${t('item')}s` : t('item')}`}</small>
                        </Flexblock>
                    </LocationsReelSlide>

                    {non_active_completions.map(location =>
                        <LocationsReelSlide gap={REEL_GAP}>
                            <Flexblock gap='var(--space-2xs)'>
                                <h3>
                                    <a href={translatePath(`/market/sell-orders?${query_string({
                                            location_name: location.location_name
                                        })}`)}>
                                        {location.location_name}
                                    </a>
                                </h3>
                                <Progress
                                    class:list={[ 'w-full', { danger: location.completion < 30 } ]}
                                    max="100"
                                    value={location.completion > 0 ? location.completion : 1}
                                    data-tippy-content={`${location.completion.toFixed(0)}%`}
                                >
                                    {location.completion.toFixed(2)}%
                                </Progress>
                                <small>{`${location.item_count} ${location.item_count != 1 ? `${t('item')}s` : t('item')}`}</small>
                            </Flexblock>
                        </LocationsReelSlide>
                    )}
                </LocationsReel>

                {expected_by_group.length > 0 &&
                    <Flexblock gap='var(--space-l)'>
                        <h3 class="[ section-heading ]">Expected Items</h3>
                        {expected_by_group.map(([groupName, groupItems]) =>
                            <Flexblock gap='var(--space-s)' class="[ expected-group ]">
                                <h4 class="[ group-heading ]">{groupName}</h4>
                                <BlockList role="list" gap='var(--space-3xs)'>
                                    {groupItems.map((item) =>
                                        <div class="[ sell-order-row ]" x-show="show_item($el)">
                                            <div class="[ sell-order-grid ]">
                                                <FlexInline gap='var(--space-s)' class="[ items-center min-w-0 ]">
                                                    {item.type_id
                                                        ? <ItemPicture item_id={item.type_id} item_name={item.item_name} size={32} icon_quality={32} />
                                                        : <span class="[ sell-order-icon-placeholder ]" aria-hidden="true" />
                                                    }
                                                    <Flexblock gap='var(--space-3xs)' class="[ min-w-0 flex-1 ]">
                                                        <FlexInline justification='space-between'>
                                                            <span class="[ item-name ]">{item.item_name}</span>
                                                            <span class="[ quantity ]">{item.current_quantity}/{item.expected_quantity}</span>
                                                        </FlexInline>
                                                        <Progress
                                                            class:list={[ 'w-full', { danger: item.low_amount } ]}
                                                            max="100"
                                                            value={item.completion > 0 ? item.completion : 0.1}
                                                            data-tippy-content={`${item.completion.toFixed(0)}%`}
                                                        >
                                                            {item.completion.toFixed(2)}%
                                                        </Progress>
                                                    </Flexblock>
                                                </FlexInline>

                                                {!is_baseline && (
                                                    <div class="[ markup-cell ]">
                                                        {item.markup_pct != null ? (
                                                            <span class:list={['markup-badge', { positive: item.markup_pct > 0, negative: item.markup_pct < 0 }]}
                                                                data-tippy-content={`${item.lowest_price?.toLocaleString('en-US', { maximumFractionDigits: 0 })} ISK vs ${item.baseline_price?.toLocaleString('en-US', { maximumFractionDigits: 0 })} ISK baseline`}
                                                            >
                                                                {item.markup_pct > 0 ? '+' : ''}{item.markup_pct.toFixed(0)}%
                                                            </span>
                                                        ) : (
                                                            <span class="[ markup-badge no-data ]" data-tippy-content="No price data">—</span>
                                                        )}
                                                    </div>
                                                )}

                                                {item.issuer_ids.length > 0 &&
                                                    <FlexInline gap='var(--space-3xs)' class="[ sell-order-issuers ]">
                                                        {item.issuer_ids.map((issuer_id) => (
                                                            <CharacterPicture
                                                                character_id={issuer_id}
                                                                size={24}
                                                                icon_quality={32}
                                                            />
                                                        ))}
                                                    </FlexInline>
                                                }
                                            </div>
                                        </div>
                                    )}
                                    <p class="[ no-result-text ]">{t('no_results')}</p>
                                </BlockList>
                            </Flexblock>
                        )}
                    </Flexblock>
                }

                {other_by_group.length > 0 &&
                    <Flexblock gap='var(--space-l)'>
                        <h3 class="[ section-heading ]">Other Items on Market</h3>
                        {other_by_group.map(([groupName, groupItems]) =>
                            <Flexblock gap='var(--space-s)' class="[ other-group ]">
                                <h4 class="[ group-heading ]">{groupName}</h4>
                                <BlockList role="list" gap='var(--space-3xs)'>
                                    {groupItems.map((item) => (
                                        <div class="[ sell-order-row ]" x-show="show_item($el)">
                                            <Wrapper
                                                padding_block='0'
                                                padding_inline='0'
                                                max_width='54rem'
                                            >
                                                <FlexInline gap='var(--space-s)' justification='space-between' class="[ items-center ]">
                                                    <FlexInline gap='var(--space-s)' class="[ items-center min-w-0 flex-1 ]">
                                                        {item.type_id
                                                            ? <ItemPicture item_id={item.type_id} item_name={item.item_name} size={32} icon_quality={32} />
                                                            : <span class="[ sell-order-icon-placeholder ]" aria-hidden="true" />
                                                        }
                                                        <span class="[ item-name ]">{item.item_name}</span>
                                                    </FlexInline>
                                                    <FlexInline gap='var(--space-3xs)' class="[ items-center ]">
                                                        {item.issuer_ids.length > 0 &&
                                                            <FlexInline gap='var(--space-3xs)' class="[ sell-order-issuers ]">
                                                                {item.issuer_ids.map((issuer_id) => (
                                                                    <CharacterPicture
                                                                        character_id={issuer_id}
                                                                        size={24}
                                                                        icon_quality={32}
                                                                    />
                                                                ))}
                                                            </FlexInline>
                                                        }
                                                        <span class="[ quantity ]">{item.current_quantity}</span>
                                                    </FlexInline>
                                                </FlexInline>
                                            </Wrapper>
                                        </div>
                                    ))}
                                    <p class="[ no-result-text ]">{t('no_results')}</p>
                                </BlockList>
                            </Flexblock>
                        )}
                    </Flexblock>
                }
            </Flexblock>
        :
            <p>{t('no_market_locations')}</p>
        }
    </PageDefault>
</Viewport>

<style lang="scss">
    :not([style="display: none;"]) ~ .no-result-text {
        display: none;
    }

    .section-heading {
        font-size: var(--step-1);
        font-family: var(--heading-font);
        text-transform: uppercase;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: var(--space-3xs);
    }

    .item-name {
        font-size: var(--step--1);
        min-width: 0;
        flex: 1;
    }

    .quantity {
        font-family: var(--heading-font);
        text-transform: uppercase;
        font-size: var(--step-0);
        font-weight: 400;
        color: var(--highlight);
    }

    .markup-badge {
        font-family: var(--heading-font);
        font-size: var(--step--2);
        padding: 1px 6px;
        border-radius: 3px;
        white-space: nowrap;
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.5);

        &.positive {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
        }

        &.negative {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
        }

        &.no-data {
            background: rgba(255, 255, 255, 0.04);
            color: rgba(255, 255, 255, 0.25);
        }
    }

    .sell-order-grid {
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: var(--space-s);
        align-items: center;
    }

    .markup-cell {
        display: flex;
        justify-content: flex-end;
        min-width: 4rem;
    }

    .sell-order-icon-placeholder {
        display: block;
        width: 32px;
        height: 32px;
        min-width: 32px;
        background: rgba(255, 255, 255, 0.06);
        border-radius: 2px;
    }

    .sell-order-issuers {
        flex-shrink: 0;
    }

    .sell-order-issuers picture img {
        border-radius: 2px;
    }

    .sell-orders-copy-wrapper {
        position: relative;
    }

    .copy-options-toggle {
        background: transparent;
        border: none;
        color: var(--highlight);
        cursor: pointer;
        font-size: var(--step--1);
        padding: 0 var(--space-2xs);
    }

    .copy-options-panel {
        position: absolute;
        top: 100%;
        left: 0;
        margin-top: var(--space-2xs);
        padding: var(--space-s);
        background: var(--surface);
        border: 1px solid rgba(255, 255, 255, 0.1);
        min-width: 14rem;
        z-index: 10;
    }

    .copy-options-title {
        font-size: var(--step--1);
        margin: 0 0 var(--space-2xs) 0;
    }

    .copy-options-actions {
        margin-bottom: var(--space-2xs);
    }

    .copy-options-actions button {
        background: transparent;
        border: none;
        color: var(--highlight);
        cursor: pointer;
        font-size: var(--step--2);
    }

    .copy-options-checkboxes {
        max-height: 12rem;
        overflow-y: auto;
    }

    .copy-options-label {
        display: flex;
        align-items: center;
        gap: var(--space-2xs);
        cursor: pointer;
        font-size: var(--step--1);
    }

    .copy-btn {
        display: inline-block;
        text-decoration: none;
        font-size: var(--step--0);
        font-family: var(--button-font);
        font-weight: 600;
        padding: var(--space-2xs) var(--space-xs-s);
        border: solid 1px var(--fleet-red);
        color: var(--button-color);
        background-color: var(--fleet-red);
        cursor: pointer;
        transition: var(--fast-transition);

        &:hover:not([disabled]) {
            transform: scale(1.1);
        }

        &:active:not([disabled]) {
            transform: scale(1);
        }

        &[disabled] {
            filter: saturate(50%);
            cursor: default;
        }
    }

    .copy-selected-btn {
        margin-top: var(--space-2xs);
    }

    .group-heading {
        font-size: var(--step-0);
        font-family: var(--heading-font);
        text-transform: uppercase;
        color: var(--highlight);
        margin: 0 0 var(--space-2xs) 0;
        padding-bottom: var(--space-3xs);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    [x-cloak] {
        display: none !important;
    }
</style>
