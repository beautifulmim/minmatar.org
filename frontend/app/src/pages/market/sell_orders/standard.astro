---
import { i18n } from '@helpers/i18n'
const { t, translatePath } = i18n(Astro.url)

import type { MarketLocationUI, SelectOptions } from '@dtypes/layout_components';
import type { SellOrderLocation, SellOrderItem } from '@dtypes/api.minmatar.org'
import { get_sell_orders } from '@helpers/api.minmatar.org/market'

let market_locations: SellOrderLocation[] = []
let data_fetching_error = ''

try {
    market_locations = await get_sell_orders()
} catch (error) {
    data_fetching_error = error.message
}

let active_location_name = Astro.url.searchParams.get('location_name') ?? (market_locations[0]?.location_name ?? '')

if (market_locations.length > 0) {
    if (active_location_name === '' || !market_locations.find(location => location.location_name === active_location_name) )
        active_location_name = market_locations[0].location_name
}

const active_market_locations = market_locations.find(market_location => market_location.location_name === active_location_name)

const market_locations_ui:MarketLocationUI[] = market_locations.map(location => {
    return {
        name: location.location_name,
        items_count: location.items.length,
        items: location.items,
        completion: 0, // To be calculated
    } as MarketLocationUI
})

import { query_string } from '@helpers/string';

const CONTRACTS_PARTIAL_URL = translatePath(`/partials/sell_orders_component?${query_string({
    location_name: active_location_name
})}`)

const active_market_locations_ui = market_locations_ui.find(location => location.name === active_location_name)
const items_count = active_market_locations_ui?.items.length ?? 0
const items_count_text = (items_count != 1 ? t('showing_orders_plural') : t('showing_orders_singular')).replace('{count}', String(items_count))

let categories:string[] = []
let shortfall_items_by_category:Record<string, SellOrderItem[]> = {}
let shortfall_categories:string[] = []
let groups_by_category:Record<string,string[]> = {
    all: []
}

active_market_locations_ui?.items.map(item => {
    categories.push(item.category_name)

    if (item.current_quantity < item.expected_quantity) {
        if (!shortfall_items_by_category[item.category_name])
            shortfall_items_by_category[item.category_name] = []

        shortfall_items_by_category[item.category_name].push(item)
        shortfall_categories.push(item.category_name)
    }

    if (!groups_by_category[item.category_name])
        groups_by_category[item.category_name] = []

    groups_by_category['all'].push(item.group_name)
    groups_by_category[item.category_name].push(item.group_name)
})

import { unique_values } from '@helpers/array'
categories = unique_values(categories)
shortfall_categories = unique_values(shortfall_categories)
categories = categories.sort((a, b) => a.localeCompare(b))
shortfall_categories = shortfall_categories.sort((a, b) => a.localeCompare(b))

let groups_by_category_options:Record<string, SelectOptions[]> = {}

const all_categories = [ 'all', ...categories ]
all_categories.map(category => {
    groups_by_category_options[category] = unique_values(groups_by_category[category]).map(value => {
        return { label: value, value: value } as SelectOptions
    })
})

const categories_select_options = categories.map( category_name => {
    return { label: category_name, value: category_name } as SelectOptions
})

const non_active_market_locations_ui = market_locations_ui.filter(location => location.name !== active_location_name)

const is_video_cover = active_location_name === 'R-6KYM - Here be Rats' || active_location_name === 'Amamake - 5 times nearly AT winners'

import Viewport from '@layouts/Viewport.astro';

import PageDefault from '@components/page/PageDefault.astro';
import PageTitle from '@components/page/PageTitle.astro';

import Flexblock from '@components/compositions/Flexblock.astro';
import FlexInline from '@components/compositions/FlexInline.astro';

import ErrorRefetch from '@components/blocks/ErrorRefetch.astro';
import Input from '@components/blocks/Input.astro'
import Select from '@components/blocks/Select.astro';
import SelectFinder from '@components/blocks/SelectFinder.astro';
import MarketList from '@components/blocks/MarketList.astro';
import ButtonExportShortfallItems from '@components/blocks/ButtonExportShortfallItems.astro';

import MagnifierIcon from '@components/icons/buttons/MagnifierIcon.astro';

const page_title = t('sell_orders.page_title')
---

<Viewport
    title={page_title}
    meta_description={t('sell_orders.meta_description')}
    components={{
        alert_dialog: true,
        confirm_dialog: true,
    }}
>
    <PageDefault
        cover={{
			video: active_location_name === 'R-6KYM - Here be Rats' ? '/videos/r6-loop.webm' :
					active_location_name === 'Amamake - 5 times nearly AT winners' ? '/videos/amamake-loop.webm' :
                    undefined,
			video_thumb: active_location_name === 'R-6KYM - Here be Rats' ? '/images/home-r6-cover.jpg' :
					active_location_name === 'Amamake - 5 times nearly AT winners' ? '/images/home-amamake-cover.jpg' :
                    undefined,
            image: active_location_name === 'R-6KYM - Here be Rats' ? '/images/home-r6-cover-eve.jpg' :
					active_location_name === 'Amamake - 5 times nearly AT winners' ? '/images/home-amamake-cover-eve.jpg' :
                    '/images/contracts-cover.jpg',
            image_990: active_location_name === 'R-6KYM - Here be Rats' ? '/images/home-r6-cover-eve.jpg' :
					   active_location_name === 'Amamake - 5 times nearly AT winners' ? '/images/home-amamake-cover-eve.jpg' :
                       '/images/contracts-cover.jpg',
            animated: false,
            scrollable: !is_video_cover,
            overlay: !is_video_cover,
        }}
        x-data={`{
            items_count: ${items_count},
            item_name_filter: '',
            item_category_filter: 'all',
            item_group_filter: '-1',
            showing_items_plural: '${t('showing_items_plural')}',
            showing_items_singular: '${t('showing_items_singular')}',
            categories_select_options: ${JSON.stringify(categories_select_options)},
            groups_by_category_options: ${JSON.stringify(groups_by_category_options)},
            countVisibleElements(selector, parent = document) {
                const elements = parent.querySelectorAll(selector)
                let visible_count = 0

                elements.forEach(element => {
                    const is_visible = element.offsetParent !== null
                    if (is_visible)
                        visible_count++
                })

                return visible_count
            },
            show_item(el) {
                const name_filter_element = el.querySelectorAll('.title')
                const category_filter_element = el.querySelectorAll('.category')
                const group_filter_element = el.querySelectorAll('.group')

                const name_filter = ( this.item_name_filter === '' || name_filter_element[0].textContent.toLowerCase().includes(this.item_name_filter.toLowerCase()) )
                const category_filter = ( this.item_category_filter === 'all' || category_filter_element[0].textContent.toLowerCase().includes(this.item_category_filter.toLowerCase()) )
                const group_filter = ( this.item_group_filter === '-1' || group_filter_element[0].textContent.toLowerCase().includes(this.item_group_filter.toLowerCase()) )

                return name_filter && category_filter && group_filter
            },
        }`}
    >
        <FlexInline slot="header" justification='space-between' class="[ w-full ]">
            <Flexblock gap="var(--space-3xs)">
                <PageTitle>
                    {page_title}
                </PageTitle>
                <small x-text="(items_count != 1 ? showing_items_plural : showing_items_singular).replace('{count}', String(items_count))">
                    {items_count_text}
                </small>
            </Flexblock>
            <FlexInline>
                <Input type="text"
                    placeholder={t('filter')}
                    x-model="item_name_filter"
                    x-on:keyup="setTimeout(function () { items_count = countVisibleElements('.title') })"
                    x-init="$el.focus()"
                >
                    <MagnifierIcon slot="icon" />
                </Input>

                <Select
                    x-model="item_category_filter"
                    x-on:change="item_group_filter = '-1'; setTimeout(function () { items_count = countVisibleElements('.title') }, 200)"
                >
                    <option selected value="all">{t('all_categories')}</option>
                    <template x-for="option in categories_select_options">
                        <option x-bind:value="option.value" x-text="option.label" />
                    </template>
                </Select>

                <div class="[ hidden 2xl:!block ]">
                    <SelectFinder
                        size={32}
                        placeholder={t('all_item_groups')}
                        options="groups_by_category_options[item_category_filter]"
                        model="item_group_filter"
                        width='280px'
                    />
                </div>
            </FlexInline>
        </FlexInline>

        <FlexInline slot="subheader">
            <ButtonExportShortfallItems
                shortfall_items_by_category={shortfall_items_by_category}
                shortfall_categories={shortfall_categories}
            />
        </FlexInline>
    
        {data_fetching_error ?
            <ErrorRefetch
                args={{
                    partial: CONTRACTS_PARTIAL_URL,
                    message: data_fetching_error,
                    delay: 0,
                }}
            />
            :
            active_market_locations_ui !== undefined ?
                <MarketList
                    active_market_locations_ui={active_market_locations_ui}
                    non_active_market_locations_ui={non_active_market_locations_ui}
                    is_baseline={active_market_locations?.is_price_baseline ?? false}
                    init_tooltips={false}
                /> :
                <p>{t('no_market_locations')}</p>
        }
	</PageDefault>
</Viewport>